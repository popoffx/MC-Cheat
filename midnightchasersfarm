-- // MIDNIGHT CHASERS FARM & UTILITY - ULTIMATE EDITION BY POPOFF (MODIFIED) \\ --

-- [0] VARIABLES & SERVICES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local LocalPlayer = Players.LocalPlayer

-- Global State Variables
getfenv().auto = false
_G.test = false
getfenv().carFly = false
getfenv().espEnabled = false
getfenv().fullBright = false
getfenv().hitboxExpanded = false

-- New Variables for Speed/Accel
getfenv().driveSpeedLimit = 0     -- The speed you want to force
getfenv().superAccel = false      -- The acceleration toggle

-- Storage for original sizes (for Hitbox Expander)
local originalSizes = {}

-- [1] UTILITY FUNCTIONS

-- Function to handle Traffic (Client Side)
local function clearTraffic(state)
	local trafficFolder = Workspace:FindFirstChild("NPCVehicles") and Workspace.NPCVehicles:FindFirstChild("Vehicles")
	if not trafficFolder then return end

	if state then
		if not getfenv().hiddenTraffic then
			getfenv().hiddenTraffic = Instance.new("Folder", game.ReplicatedStorage)
			getfenv().hiddenTraffic.Name = "HiddenNPCVehicles"
		end
		for _, v in pairs(trafficFolder:GetChildren()) do
			v.Parent = getfenv().hiddenTraffic
		end
		getfenv().trafficConnection = trafficFolder.ChildAdded:Connect(function(child)
			task.wait() 
			if getfenv().hiddenTraffic then
				child.Parent = getfenv().hiddenTraffic
			end
		end)
	else
		if getfenv().trafficConnection then
			getfenv().trafficConnection:Disconnect()
			getfenv().trafficConnection = nil
		end
		if getfenv().hiddenTraffic then
			for _, v in pairs(getfenv().hiddenTraffic:GetChildren()) do
				v.Parent = trafficFolder
			end
			getfenv().hiddenTraffic:Destroy()
			getfenv().hiddenTraffic = nil
		end
	end
end

-- ESP Function
local function toggleESP(state)
	getfenv().espEnabled = state
	local holder = game.CoreGui:FindFirstChild("ESPHolder") or Instance.new("Folder", game.CoreGui)
	holder.Name = "ESPHolder"
	
	if not state then
		holder:Destroy()
		return
	end

	task.spawn(function()
		while getfenv().espEnabled do
			for _, plr in pairs(Players:GetPlayers()) do
				if plr ~= LocalPlayer and plr.Character and plr.Character:FindFirstChild("HumanoidRootPart") then
					if not holder:FindFirstChild(plr.Name) then
						local hl = Instance.new("Highlight")
						hl.Name = plr.Name
						hl.Adornee = plr.Character
						hl.FillColor = Color3.fromRGB(0, 255, 100)
						hl.OutlineColor = Color3.fromRGB(255, 255, 255)
						hl.FillTransparency = 0.5
						hl.OutlineTransparency = 0
						hl.Parent = holder
					end
				end
			end
			for _, hl in pairs(holder:GetChildren()) do
				if not Players:FindFirstChild(hl.Name) then hl:Destroy() end
			end
			task.wait(1)
		end
	end)
end

-- Car Fly Logic
local function toggleCarFly(state)
	getfenv().carFly = state
	local speed = 200
	
	if state then
		task.spawn(function()
			local bv = Instance.new("BodyVelocity")
			
			while getfenv().carFly do
				local char = LocalPlayer.Character
				if char and char:FindFirstChild("Humanoid") and char.Humanoid.SeatPart then
					local car = char.Humanoid.SeatPart.Parent
					local root = car and car.PrimaryPart
					
					if root then
						if not root:FindFirstChild("FlyVelocity") then
							bv = Instance.new("BodyVelocity")
							bv.Name = "FlyVelocity"
							bv.MaxForce = Vector3.new(1e9, 1e9, 1e9)
							bv.Parent = root
						end
						
						local cam = Workspace.CurrentCamera
						local moveDir = Vector3.zero
						
						if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + cam.CFrame.LookVector end
						if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - cam.CFrame.LookVector end
						if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - cam.CFrame.RightVector end
						if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + cam.CFrame.RightVector end
						if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0, 1, 0) end
						if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir = moveDir - Vector3.new(0, 1, 0) end
						
						root:FindFirstChild("FlyVelocity").Velocity = moveDir * speed
						local lookPos = root.Position + cam.CFrame.LookVector
						root.CFrame = CFrame.new(root.Position, Vector3.new(lookPos.X, root.Position.Y, lookPos.Z))
					end
				end
				RunService.Heartbeat:Wait()
			end
			for _, v in pairs(Workspace:GetDescendants()) do if v.Name == "FlyVelocity" then v:Destroy() end end
		end)
	else
		for _, v in pairs(Workspace:GetDescendants()) do if v.Name == "FlyVelocity" then v:Destroy() end end
	end
end

-- [Hitbox Expander Logic]
local function toggleHitboxExpander(state)
	getfenv().hitboxExpanded = state
	
	-- Helper to check if a part is a checkpoint
	local function isCheckpoint(part)
		if not part:IsA("BasePart") then return false end
		-- Check common names or if name is a number
		if part.Name == "Checkpoint" or part.Name == "Ring" or tonumber(part.Name) ~= nil then
			-- Usually checkpoints are non-collide or transparent
			if part.Transparency > 0.1 or part.CanCollide == false then
				return true
			end
		end
		return false
	end

	if state then
		-- Expand
		for _, v in pairs(Workspace:GetDescendants()) do
			if isCheckpoint(v) then
				if not originalSizes[v] then originalSizes[v] = v.Size end
				v.Size = Vector3.new(60, 60, 60)
				v.Transparency = 0.5 -- Make visible so you know it's working
				v.Color = Color3.fromRGB(0, 255, 0)
			end
		end
	else
		-- Restore
		for part, size in pairs(originalSizes) do
			if part and part.Parent then
				part.Size = size
				part.Transparency = 1 -- Assume invisible originally
			end
		end
		table.clear(originalSizes)
	end
end

-- [Smart Race Autopilot Logic]
local function startSmartRace()
	local char = LocalPlayer.Character
	if not char or not char:FindFirstChild("Humanoid") or not char.Humanoid.SeatPart then
		game.StarterGui:SetCore("SendNotification", {Title = "Error"; Text = "Please get in a car first!"; Duration = 3;})
		return
	end
	
	local car = char.Humanoid.SeatPart.Parent
	local speed = getfenv().speed or 300
	
	-- 1. Scan for the active race container
	local raceContainer = nil
	local checkpoints = {}
	
	-- Search Workspace for models containing sequential numbers
	for _, model in pairs(Workspace:GetDescendants()) do
		if model:IsA("Model") or model:IsA("Folder") then
			if model:FindFirstChild("1") and model:FindFirstChild("2") then
				raceContainer = model
				break
			end
		end
	end
	
	if not raceContainer then
		game.StarterGui:SetCore("SendNotification", {Title = "Auto Race"; Text = "No active race found! (Looked for '1', '2'...)"; Duration = 3;})
		return
	end
	
	-- 2. Collect and Sort Checkpoints
	for _, child in pairs(raceContainer:GetChildren()) do
		local num = tonumber(child.Name)
		if num then
			table.insert(checkpoints, {part = child, index = num})
		end
	end
	
	table.sort(checkpoints, function(a, b) return a.index < b.index end)
	
	-- 3. Tween to them
	ensureGroundPart()
	game.StarterGui:SetCore("SendNotification", {Title = "Auto Race"; Text = "Race found! Starting autopilot..."; Duration = 3;})

	for _, pt in ipairs(checkpoints) do
		if not getfenv().auto then break end -- Emergency stop check
		
		-- Tween slightly above the checkpoint to avoid clipping
		local targetPos = pt.part.CFrame * CFrame.new(0, 0, 0) 
		tweenToPosition(car, targetPos, speed)
		
		-- Small wait to ensure registration
		task.wait(0.1)
	end
	
	game.StarterGui:SetCore("SendNotification", {Title = "Auto Race"; Text = "Race Finished!"; Duration = 3;})
end

-- Car Jump
UserInputService.InputBegan:Connect(function(input, gpe)
	if gpe then return end
	if input.KeyCode == Enum.KeyCode.Space and not getfenv().carFly then
		local char = LocalPlayer.Character
		if char and char:FindFirstChild("Humanoid") and char.Humanoid.SeatPart then
			local car = char.Humanoid.SeatPart.Parent
			if car and car.PrimaryPart then
				car.PrimaryPart.AssemblyLinearVelocity = car.PrimaryPart.AssemblyLinearVelocity + Vector3.new(0, 60, 0)
			end
		end
	end
end)

-- [NEW] SPEED & ACCELERATION LOGIC
RunService.RenderStepped:Connect(function()
    local char = LocalPlayer.Character
    if char and char:FindFirstChild("Humanoid") and char.Humanoid.SeatPart then
        local seat = char.Humanoid.SeatPart
        local car = seat.Parent
        local root = car.PrimaryPart
        
        -- 1. Super Acceleration
        if getfenv().superAccel then
            if seat:IsA("VehicleSeat") then
                seat.Torque = 100000 -- Massive torque for instant 0-100
            end
        end

        -- 2. Force Drive Speed
        local forcedSpeed = tonumber(getfenv().driveSpeedLimit)
        if forcedSpeed and forcedSpeed > 0 and root then
            -- Only boost if holding W and speed is less than target
            if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                if root.AssemblyLinearVelocity.Magnitude < forcedSpeed then
                    -- Keep current direction, apply new speed
                    root.AssemblyLinearVelocity = root.CFrame.LookVector * forcedSpeed
                end
            end
        end
    end
end)


-- [2] ANTI-AFK & HELPERS
task.spawn(function()
	for i, v in pairs(Workspace:GetDescendants()) do
		if v.ClassName == "Model" then
			task.spawn(function() LocalPlayer:RequestStreamAroundAsync(v.WorldPivot.Position, 3) end)
			task.wait()
		end
	end
end)

warn("Anti afk launching")
LocalPlayer.Idled:connect(function()
	warn("Anti afk launched successfully!!!")
	game:GetService("VirtualUser"):CaptureController()
	game:GetService("VirtualUser"):ClickButton2(Vector2.new())
end)

local function reachedMax(value)
	local test = 0
	for i, v in pairs(value:GetDescendants()) do if v:IsA("Seat") then test = test + 1 end end
	test = test * 5
	return (value:FindFirstChild("Gifts") and #value.Gifts:GetChildren() == test)
end

local function hideWorkspaceObjects(plr)
	if not game.ReplicatedStorage:FindFirstChild("mrbackupfolder") then
		local folder = Instance.new("Folder", game.ReplicatedStorage)
		folder.Name = "mrbackupfolder"
	end
	for i, v in pairs(Workspace:GetChildren()) do
		if (v.ClassName == "Model" and not string.find(v.Name, plr.Name) and not string.find(v.Name, plr.DisplayName) and not string.find(v.Name, "Gift") and v.Name ~= "") or
		   (v.ClassName == "Folder" and not string.find(v.Name, plr.Name) and not string.find(v.Name, plr.DisplayName) and not string.find(v.Name, "Gift") and v.Name ~= "") or
		   v:IsA("MeshPart") then
			v.Parent = game.ReplicatedStorage:FindFirstChild("mrbackupfolder")
		end
	end
end

local function restoreWorkspaceObjects()
	if game.ReplicatedStorage:FindFirstChild("mrbackupfolder") then
		for i, v in pairs(game.ReplicatedStorage:FindFirstChild("mrbackupfolder"):GetChildren()) do
			v.Parent = Workspace
			task.wait()
		end
	end
end

local function ensureGroundPart()
	if not _G.ooga then
		local new = Instance.new("Part", Workspace)
		new.Anchored = true; new.Size = Vector3.new(10000, 10, 10000)
		_G.ooga = new
	end
end

local function tweenToPosition(car, targetCFrame, speed)
	-- Helper to support both Vector3 and CFrame inputs
	local targetPos = (typeof(targetCFrame) == "CFrame") and targetCFrame.Position or targetCFrame
	
	local plr = LocalPlayer
	local dist = (plr.Character.HumanoidRootPart.Position - targetPos).magnitude
	local TweenInfoToUse = TweenInfo.new(dist / speed, Enum.EasingStyle.Lin
