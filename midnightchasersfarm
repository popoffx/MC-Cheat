-- // MIDNIGHT CHASERS FARM & UTILITY - REMASTERED // --

-- [0] SERVICES & VARIABLES
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")
local TweenService = game:GetService("TweenService")
local Workspace = game:GetService("Workspace")
local CoreGui = game:GetService("CoreGui")
local LocalPlayer = Players.LocalPlayer

-- Global State Variables
getfenv().autoRace = false
getfenv().autoDeliver = false
getfenv().carFly = false
getfenv().espEnabled = false
getfenv().fullBright = false
getfenv().hitboxExpanded = false
getfenv().loopRace = false -- New: Loop the race
getfenv().speed = 250      -- Default Tween Speed

-- Storage
local originalSizes = {}
local activeTweens = {}

-- [1] MODERN UI LIBRARY (Integrated)
local Library = {}
local UIConfig = {
    MainColor = Color3.fromRGB(25, 25, 25),
    SecondaryColor = Color3.fromRGB(35, 35, 35),
    AccentColor = Color3.fromRGB(0, 170, 255),
    TextColor = Color3.fromRGB(240, 240, 240),
    Font = Enum.Font.GothamBold,
    CornerRadius = UDim.new(0, 8)
}

function Library:CreateWindow(options)
    local WindowName = options.text or "Script"
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "MidnightChasersUI_Remastered"
    pcall(function() ScreenGui.Parent = CoreGui end)
    if not ScreenGui.Parent then ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui") end

    local MainFrame = Instance.new("Frame", ScreenGui)
    MainFrame.Name = "MainFrame"; MainFrame.Size = UDim2.fromOffset(240, 320); MainFrame.Position = UDim2.fromScale(0.1, 0.1)
    MainFrame.BackgroundColor3 = UIConfig.MainColor; MainFrame.BorderSizePixel = 0
    Instance.new("UICorner", MainFrame).CornerRadius = UIConfig.CornerRadius
    local Stroke = Instance.new("UIStroke", MainFrame); Stroke.Color = UIConfig.AccentColor; Stroke.Thickness = 1; Stroke.Transparency = 0.5
    
    -- Dragging
    local dragging, dragStart, startPos
    MainFrame.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true; dragStart = input.Position; startPos = MainFrame.Position
        end
    end)
    UserInputService.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement and dragging then
            local delta = input.Position - dragStart
            MainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
        end
    end)
    UserInputService.InputEnded:Connect(function(input) if input.UserInputType == Enum.UserInputType.MouseButton1 then dragging = false end end)

    local TitleLabel = Instance.new("TextLabel", MainFrame); TitleLabel.Size = UDim2.new(1, -10, 0, 35); TitleLabel.Position = UDim2.new(0, 10, 0, 0)
    TitleLabel.BackgroundTransparency = 1; TitleLabel.Text = WindowName; TitleLabel.TextColor3 = UIConfig.AccentColor
    TitleLabel.TextSize = 16; TitleLabel.Font = UIConfig.Font; TitleLabel.TextXAlignment = Enum.TextXAlignment.Left

    local Container = Instance.new("ScrollingFrame", MainFrame); Container.Name = "Container"; Container.Size = UDim2.new(1, -10, 1, -45)
    Container.Position = UDim2.new(0, 5, 0, 40); Container.BackgroundTransparency = 1; Container.ScrollBarThickness = 2
    local UIList = Instance.new("UIListLayout", Container); UIList.Padding = UDim.new(0, 6); UIList.SortOrder = Enum.SortOrder.LayoutOrder
    
    local Elements = {}
    
    function Elements:AddSection(text)
        local SecLabel = Instance.new("TextLabel", Container)
        SecLabel.Size = UDim2.new(1, 0, 0, 20)
        SecLabel.BackgroundTransparency = 1
        SecLabel.Text = "- " .. text .. " -"
        SecLabel.TextColor3 = Color3.fromRGB(150, 150, 150)
        SecLabel.Font = Enum.Font.Gotham; SecLabel.TextSize = 12
    end

    function Elements:AddBox(text, callback)
        local BoxFrame = Instance.new("Frame", Container); BoxFrame.Size = UDim2.new(1, -5, 0, 35); BoxFrame.BackgroundColor3 = UIConfig.SecondaryColor
        Instance.new("UICorner", BoxFrame).CornerRadius = UDim.new(0, 6)
        local TextBox = Instance.new("TextBox", BoxFrame); TextBox.Size = UDim2.new(1, 0, 1, 0); TextBox.BackgroundTransparency = 1
        TextBox.PlaceholderText = text; TextBox.TextColor3 = UIConfig.TextColor; TextBox.Font = Enum.Font.GothamMedium; TextBox.TextSize = 14
        TextBox.FocusLost:Connect(function() pcall(callback, TextBox, true) end)
        Container.CanvasSize = UDim2.new(0, 0, 0, UIList.AbsoluteContentSize.Y + 20)
    end

    function Elements:AddToggle(text, callback)
        local isEnabled = false
        local Btn = Instance.new("TextButton", Container); Btn.Size = UDim2.new(1, -5, 0, 30); Btn.BackgroundTransparency = 1; Btn.Text = ""
        local Label = Instance.new("TextLabel", Btn); Label.Text = text; Label.Size = UDim2.new(0.7, 0, 1, 0); Label.BackgroundTransparency = 1
        Label.TextColor3 = UIConfig.TextColor; Label.Font = Enum.Font.GothamMedium; Label.TextSize = 14; Label.TextXAlignment = Enum.TextXAlignment.Left
        local Switch = Instance.new("Frame", Btn); Switch.Size = UDim2.new(0, 40, 0, 20); Switch.Position = UDim2.new(1, -45, 0.5, 0); Switch.AnchorPoint = Vector2.new(0, 0.5); Switch.BackgroundColor3 = Color3.fromRGB(50,50,50)
        Instance.new("UICorner", Switch).CornerRadius = UDim.new(1, 0)
        local Circle = Instance.new("Frame", Switch); Circle.Size = UDim2.new(0, 16, 0, 16); Circle.Position = UDim2.new(0, 2, 0.5, 0); Circle.AnchorPoint = Vector2.new(0, 0.5); Circle.BackgroundColor3 = Color3.fromRGB(200,200,200)
        Instance.new("UICorner", Circle).CornerRadius = UDim.new(1, 0)
        
        Btn.MouseButton1Click:Connect(function()
            isEnabled = not isEnabled; callback(isEnabled)
            local tPos = isEnabled and UDim2.new(1, -18, 0.5, 0) or UDim2.new(0, 2, 0.5, 0)
            local tCol = isEnabled and UIConfig.AccentColor or Color3.fromRGB(50,50,50)
            TweenService:Create(Circle, TweenInfo.new(0.2), {Position = tPos}):Play()
            TweenService:Create(Switch, TweenInfo.new(0.2), {BackgroundColor3 = tCol}):Play()
        end)
        Container.CanvasSize = UDim2.new(0, 0, 0, UIList.AbsoluteContentSize.Y + 20)
    end

    function Elements:AddButton(text, callback)
        local Btn = Instance.new("TextButton", Container); Btn.Size = UDim2.new(1, -5, 0, 30); Btn.BackgroundColor3 = UIConfig.SecondaryColor
        Btn.Text = text; Btn.TextColor3 = UIConfig.TextColor; Btn.Font = Enum.Font.GothamMedium; Btn.TextSize = 14
        Instance.new("UICorner", Btn).CornerRadius = UDim.new(0, 6)
        Btn.MouseButton1Click:Connect(function()
            TweenService:Create(Btn, TweenInfo.new(0.1), {BackgroundColor3 = UIConfig.AccentColor}):Play()
            task.wait(0.1)
            TweenService:Create(Btn, TweenInfo.new(0.3), {BackgroundColor3 = UIConfig.SecondaryColor}):Play()
            callback() 
        end)
        Container.CanvasSize = UDim2.new(0, 0, 0, UIList.AbsoluteContentSize.Y + 20)
    end

    UIList:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(function()
        Container.CanvasSize = UDim2.new(0, 0, 0, UIList.AbsoluteContentSize.Y + 20)
    end)

    return Elements
end

-- [2] UTILITY FUNCTIONS

-- Helper: Ensure Ground Platform (Prevents falling while tweening)
local function ensureGroundPart()
    if not _G.ooga or not _G.ooga.Parent then
        local new = Instance.new("Part", Workspace)
        new.Name = "TweenPlatform"
        new.Anchored = true
        new.Size = Vector3.new(10000, 2, 10000)
        new.Transparency = 1 -- Invisible
        new.CanCollide = false -- Don't hit other things
        _G.ooga = new
    end
end

-- Helper: Tween Function
local function tweenCar(targetPos)
    local char = LocalPlayer.Character
    if not char or not char:FindFirstChild("Humanoid") or not char.Humanoid.SeatPart then return end
    
    local car = char.Humanoid.SeatPart.Parent
    if not car or not car.PrimaryPart then return end
    
    ensureGroundPart()
    local speed = getfenv().speed or 250
    local dist = (car.PrimaryPart.Position - targetPos).Magnitude
    local info = TweenInfo.new(dist / speed, Enum.EasingStyle.Linear)
    
    local tweenValue = Instance.new("CFrameValue")
    tweenValue.Value = car:GetPrimaryPartCFrame()
    
    tweenValue.Changed:Connect(function()
        if not car.Parent then tweenValue:Destroy() return end
        _G.ooga.Position = tweenValue.Value.Position - Vector3.new(0, 10, 0)
        car:PivotTo(CFrame.new(tweenValue.Value.Position, targetPos))
        car.PrimaryPart.AssemblyLinearVelocity = car.PrimaryPart.CFrame.LookVector * speed
    end)
    
    local tween = TweenService:Create(tweenValue, info, {Value = CFrame.new(targetPos)})
    table.insert(activeTweens, tween)
    tween:Play()
    tween.Completed:Wait()
    tweenValue:Destroy()
end

-- Feature: Traffic Clear
local function toggleTraffic(state)
    local trafficFolder = Workspace:FindFirstChild("NPCVehicles") and Workspace.NPCVehicles:FindFirstChild("Vehicles")
    if not trafficFolder then return end

    if state then
        if not getfenv().hiddenTraffic then
            getfenv().hiddenTraffic = Instance.new("Folder", game.ReplicatedStorage)
            getfenv().hiddenTraffic.Name = "HiddenNPCVehicles"
        end
        for _, v in pairs(trafficFolder:GetChildren()) do
            v.Parent = getfenv().hiddenTraffic
        end
        getfenv().trafficConnection = trafficFolder.ChildAdded:Connect(function(child)
            task.wait()
            if getfenv().hiddenTraffic then child.Parent = getfenv().hiddenTraffic end
        end)
    else
        if getfenv().trafficConnection then getfenv().trafficConnection:Disconnect() end
        if getfenv().hiddenTraffic then
            for _, v in pairs(getfenv().hiddenTraffic:GetChildren()) do
                v.Parent = trafficFolder
            end
            getfenv().hiddenTraffic:Destroy()
            getfenv().hiddenTraffic = nil
        end
    end
end

-- Feature: Car Fly (Improved with Stabilizer)
local function toggleCarFly(state)
    getfenv().carFly = state
    local speed = 250
    
    if state then
        task.spawn(function()
            local bv, bg
            while getfenv().carFly do
                local char = LocalPlayer.Character
                if char and char:FindFirstChild("Humanoid") and char.Humanoid.SeatPart then
                    local car = char.Humanoid.SeatPart.Parent
                    local root = car and car.PrimaryPart
                    
                    if root then
                        -- BodyVelocity
                        if not root:FindFirstChild("FlyVelocity") then
                            bv = Instance.new("BodyVelocity")
                            bv.Name = "FlyVelocity"; bv.MaxForce = Vector3.new(1e9, 1e9, 1e9); bv.Parent = root
                        end
                        -- BodyGyro (Stabilizer)
                        if not root:FindFirstChild("FlyGyro") then
                            bg = Instance.new("BodyGyro")
                            bg.Name = "FlyGyro"; bg.MaxTorque = Vector3.new(1e9, 1e9, 1e9); bg.P = 3000; bg.Parent = root
                        end
                        
                        local cam = Workspace.CurrentCamera
                        local moveDir = Vector3.zero
                        
                        if UserInputService:IsKeyDown(Enum.KeyCode.W) then moveDir = moveDir + cam.CFrame.LookVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.S) then moveDir = moveDir - cam.CFrame.LookVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.A) then moveDir = moveDir - cam.CFrame.RightVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.D) then moveDir = moveDir + cam.CFrame.RightVector end
                        if UserInputService:IsKeyDown(Enum.KeyCode.Space) then moveDir = moveDir + Vector3.new(0, 1, 0) end
                        if UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then moveDir = moveDir - Vector3.new(0, 1, 0) end
                        
                        root.FlyVelocity.Velocity = moveDir * speed
                        root.FlyGyro.CFrame = cam.CFrame
                    end
                else
                    -- Cleanup if exited car
                    if bv then bv:Destroy() bv = nil end
                    if bg then bg:Destroy() bg = nil end
                end
                RunService.Heartbeat:Wait()
            end
            -- Final Cleanup
            for _, v in pairs(Workspace:GetDescendants()) do 
                if v.Name == "FlyVelocity" or v.Name == "FlyGyro" then v:Destroy() end 
            end
        end)
    end
end

-- Feature: Hitbox Expander
local function toggleHitboxExpander(state)
    getfenv().hitboxExpanded = state
    local function isTarget(part)
        if not part:IsA("BasePart") then return false end
        if part.Name == "Checkpoint" or part.Name == "Ring" or tonumber(part.Name) ~= nil or part:FindFirstChild("TouchInterest") then
            if part.Transparency > 0.1 or not part.CanCollide then return true end
        end
        return false
    end
    if state then
        for _, v in pairs(Workspace:GetDescendants()) do
            if isTarget(v) then
                if not originalSizes[v] then originalSizes[v] = v.Size end
                v.Size = Vector3.new(80, 80, 80)
                v.Transparency = 0.7
                v.Color = Color3.fromRGB(0, 255, 100)
            end
        end
    else
        for part, size in pairs(originalSizes) do
            if part.Parent then part.Size = size; part.Transparency = 1 end
        end
        table.clear(originalSizes)
    end
end

-- Feature: Teleport to Player
local function teleportToPlayer(playerName)
    local target = Players:FindFirstChild(playerName)
    local char = LocalPlayer.Character
    if target and target.Character and target.Character.PrimaryPart and char and char.PrimaryPart then
        local car = char.Humanoid.SeatPart and char.Humanoid.SeatPart.Parent
        local tCFrame = target.Character.PrimaryPart.CFrame * CFrame.new(0, 5, 0)
        
        if car then
            car:PivotTo(tCFrame)
            car.PrimaryPart.AssemblyLinearVelocity = Vector3.zero
        else
            char:PivotTo(tCFrame)
        end
    end
end

-- Feature: Smart Race Logic
local function runSmartRace()
    local char = LocalPlayer.Character
    if not char or not char.Humanoid.SeatPart then
        game.StarterGui:SetCore("SendNotification", {Title = "Error"; Text = "Enter a car first!"; Duration = 3})
        return
    end

    game.StarterGui:SetCore("SendNotification", {Title = "Auto Race"; Text = "Scanning for race..."; Duration = 3})
    
    local raceContainer = nil
    local bestCount = 0
    
    -- Find the folder with the most numbers (likely the race)
    for _, model in pairs(Workspace:GetDescendants()) do
        if model:IsA("Model") or model:IsA("Folder") then
            local count = 0
            if model:FindFirstChild("1") then count = count + 1 end
            if model:FindFirstChild("2") then count = count + 1 end
            if model:FindFirstChild("3") then count = count + 1 end
            if count >= 2 and count > bestCount then
                raceContainer = model
                bestCount = count
            end
        end
    end
    
    if not raceContainer then
        game.StarterGui:SetCore("SendNotification", {Title = "Error"; Text = "No race found."; Duration = 3})
        return 
    end

    local checkpoints = {}
    for _, child in pairs(raceContainer:GetChildren()) do
        local num = tonumber(child.Name)
        if num then table.insert(checkpoints, {part = child, index = num}) end
    end
    table.sort(checkpoints, function(a, b) return a.index < b.index end)

    repeat
        for _, pt in ipairs(checkpoints) do
            if not getfenv().autoRace then break end
            tweenCar(pt.part.Position)
            task.wait(0.05)
        end
        -- If loop is on, teleport back to start (1)
        if getfenv().autoRace and getfenv().loopRace and checkpoints[1] then
            task.wait(0.5)
            local car = char.Humanoid.SeatPart.Parent
            car:PivotTo(checkpoints[1].part.CFrame)
            task.wait(1)
        end
    until not getfenv().loopRace or not getfenv().autoRace
    
    game.StarterGui:SetCore("SendNotification", {Title = "Finished"; Text = "Race Sequence Ended"; Duration = 3})
end

-- [3] UI CONSTRUCTION
local UI = Library:CreateWindow({text = "Midnight Chasers - Remastered"})

UI:AddSection("Farming")

UI:AddBox("Tween Speed (Def: 250)", function(obj)
    getfenv().speed = tonumber(obj.Text) or 250
end)

UI:AddToggle("Auto Race (Smart)", function(state)
    getfenv().autoRace = state
    if state then
        task.spawn(runSmartRace)
    else
        for _, t in pairs(activeTweens) do t:Cancel() end
        table.clear(activeTweens)
    end
end)

UI:AddToggle("Loop Race?", function(state)
    getfenv().loopRace = state
end)

UI:AddToggle("Auto Deliver (Gifts)", function(state)
    getfenv().autoDeliver = state
    task.spawn(function()
        while getfenv().autoDeliver do
            local char = LocalPlayer.Character
            if char and char:FindFirstChild("Humanoid") and char.Humanoid.SeatPart then
                -- Find Highlighted objects or specific pickup points
                local target = nil
                for _, v in pairs(Workspace:GetDescendants()) do
                    if v:IsA("Highlight") and v.Parent then
                        target = v.Parent
                        break
                    end
                end
                
                if not target and Workspace:FindFirstChild("GiftPickup") then
                    target = Workspace.GiftPickup
                end

                if target then
                    tweenCar(target.WorldPivot.Position)
                    task.wait(0.5)
                end
            end
            task.wait(1)
        end
    end)
end)

UI:AddSection("Vehicle Mods")

UI:AddToggle("Car Fly (W/A/S/D)", function(state)
    toggleCarFly(state)
end)

UI:AddButton("Car Jump (Force)", function()
    local char = LocalPlayer.Character
    if char and char.Humanoid.SeatPart then
        char.Humanoid.SeatPart.Parent.PrimaryPart.AssemblyLinearVelocity = Vector3.new(0, 100, 0)
    end
end)

UI:AddToggle("Disable Traffic", function(state)
    toggleTraffic(state)
end)

UI:AddToggle("Hitbox Expander", function(state)
    toggleHitboxExpander(state)
end)

UI:AddSection("Player")

UI:AddBox("Teleport to Player (Name)", function(obj)
    teleportToPlayer(obj.Text)
end)

UI:AddToggle("Full Bright", function(state)
    if state then
        Lighting.ClockTime = 14
        Lighting.Brightness = 2
        Lighting.GlobalShadows = false
    else
        Lighting.ClockTime = 0
        Lighting.Brightness = 1
        Lighting.GlobalShadows = true
    end
end)

UI:AddButton("Destroy GUI / STOP", function()
    getfenv().autoRace = false
    getfenv().autoDeliver = false
    getfenv().carFly = false
    toggleTraffic(false)
    toggleHitboxExpander(false)
    for _, t in pairs(activeTweens) do t:Cancel() end
    if _G.ooga then _G.ooga:Destroy() end
    if CoreGui:FindFirstChild("MidnightChasersUI_Remastered") then
        CoreGui.MidnightChasersUI_Remastered:Destroy()
    elseif LocalPlayer.PlayerGui:FindFirstChild("MidnightChasersUI_Remastered") then
        LocalPlayer.PlayerGui.MidnightChasersUI_Remastered:Destroy()
    end
end)

-- [4] Anti-AFK
local Vu = game:GetService("VirtualUser")
LocalPlayer.Idled:connect(function()
    Vu:Button2Down(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
    task.wait(1)
    Vu:Button2Up(Vector2.new(0,0), workspace.CurrentCamera.CFrame)
end)

warn("Midnight Chasers Remastered Loaded")
